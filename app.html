<script>
// ======= ROOM LIST (always show these rooms) =======
const ROOM_LIST = [
  // 1st floor 101-106
  '101','102','103','104','105','106',
  // 2nd floor 201-206
  '201','202','203','204','205','206',
  // 3rd floor 301-306
  '301','302','303','304','305','306',
  // 4th floor 401-406
  '401','402','403','404','405','406',
  // 5th floor 501-506
  '501','502','503','504','505','506',
  // 6th floor 601-614 except 603
  '601','602','604','605','606','607','608','609','610','611','612','613','614'
];

// ======= STORAGE =======
const KEY='subari_v1';                 // keep your old key so data remains
let rooms = JSON.parse(localStorage.getItem(KEY) || '[]');
function save(){ localStorage.setItem(KEY, JSON.stringify(rooms)); }
function money(n){ return Number(n||0).toLocaleString('en-IQ'); }
function color(s){ return {green:'#22c55e',yellow:'#facc15',red:'#ef4444',gray:'#9ca3af'}[s] || '#ddd'; }

// ======= DOM HOOKS =======
const grid = document.getElementById('grid');
const dlg = document.getElementById('dlg');
const frm = document.getElementById('frm');
const q = document.getElementById('q');
let filter='all', current=null;

document.querySelectorAll('[data-filter]').forEach(b=> b.onclick=()=>{ filter=b.dataset.filter; render(); });
q?.addEventListener('input', render);

// ======= HELPERS =======
// Ensure we have an object for every room in ROOM_LIST
function ensureAllRooms(){
  const map = new Map(rooms.map(r => [String(r.roomNumber), r]));
  for(const num of ROOM_LIST){
    if(!map.has(num)){
      map.set(num, { id: 'seed_'+num, roomNumber: num, status:'gray' }); // vacant/clean
    }
  }
  rooms = Array.from(map.values());
  // Keep a stable order by room number
  rooms.sort((a,b)=> String(a.roomNumber).localeCompare(String(b.roomNumber)));
  save();
}

// ======= RENDER =======
function render(){
  ensureAllRooms(); // guarantee all rooms appear
  const term=(q?.value||'').toLowerCase();
  grid.innerHTML='';
  rooms
    .filter(r => filter==='all' ? true : r.status===filter)
    .filter(r => (String(r.roomNumber)+' '+(r.guest||'')+' '+(r.phone||'')+' '+(r.car||'')).toLowerCase().includes(term))
    .forEach(r=>{
      const card=document.createElement('div'); card.className='card';
      const stripe=document.createElement('div'); stripe.className='stripe'; stripe.style.background=color(r.status||'gray');
      const title=document.createElement('div'); title.className='room'; title.textContent='Room '+(r.roomNumber||'');
      const row=document.createElement('div'); row.className='row';
      if(r.guest)   row.innerHTML+=`<span>ðŸ‘¤ ${r.guest}</span>`;
      if(r.persons) row.innerHTML+=`<span>â€¢ ðŸ‘¥ ${r.persons}</span>`;
      if(r.nights)  row.innerHTML+=`<span>â€¢ ðŸ›Œ ${r.nights}</span>`;
      if(r.rate)    row.innerHTML+=`<span>â€¢ ðŸ’µ ${money(r.rate)}</span>`;

      const total=(+r.nights||0)*(+r.rate||0);
      const balance=Math.max(0,total-(+r.amountPaid||0));
      const foot=document.createElement('div'); foot.className='foot';
      const paidText=r.paid==='paid'?'Ù…Ø¯ÙÙˆØ¹':'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
      foot.textContent=`${paidText} â€¢ Total ${money(total)} â€¢ Balance ${money(balance)}`;

      const btns=document.createElement('div'); btns.className='row';
      const open=document.createElement('button'); open.className='btn-outline'; open.textContent='Open';
      open.onclick=()=>openDlg(r);
      const clean=document.createElement('button'); clean.className='btn-outline'; clean.textContent='Mark Clean';
      clean.onclick=()=>{ r.status='gray'; save(); render(); };

      btns.append(open, clean);
      card.append(stripe, title, row, foot, btns);
      grid.append(card);
    });
}

// ======= DIALOG =======
function openDlg(obj){
  // If opening a room that only existed as a seed, upgrade it to a real object
  if(!obj.id){ obj.id = Date.now(); }
  current = obj || {status:'gray', persons:0, nights:0, rate:0, amountPaid:0, paid:'unpaid', method:'Cash'};

  for(const el of frm.elements){ if(el.name){ el.value = current[el.name] ?? ''; } }
  dlg.showModal();
}
document.getElementById('addBtn')?.addEventListener('click', ()=>openDlg({roomNumber:ROOM_LIST[0], status:'gray'}));
document.getElementById('saveBtn')?.addEventListener('click', ()=>{
  const f = Object.fromEntries(new FormData(frm).entries());
  if(!f.roomNumber) return alert('Room number is required');

  // Ensure room exists in array (by number)
  const idx = rooms.findIndex(r => String(r.roomNumber) === String(f.roomNumber));
  if(idx === -1){
    rooms.push({ id: Date.now(), roomNumber: f.roomNumber });
  }

  // Write back values
  const target = rooms.find(r => String(r.roomNumber) === String(f.roomNumber));
  Object.assign(target, f, {
    persons:+f.persons||0, nights:+f.nights||0, rate:+f.rate||0, amountPaid:+f.amountPaid||0
  });
  save(); render(); dlg.close();
});
document.getElementById('xBtn')?.addEventListener('click', ()=>dlg.close());

// Quick totals inside dialog (optional: add live total display if you have spans)
frm?.addEventListener('input', ()=>{/* you can add live total UI here if needed */});

// ======= STATUS BUTTONS =======
document.getElementById('checkin')?.addEventListener('click', ()=>{
  if(!current) return; current.status='green'; save(); render(); dlg.close();
});
document.getElementById('checkout')?.addEventListener('click', ()=>{
  if(!current) return;
  if(!confirm('Check out this room? Clears guest details and marks Dirty.')) return;
  current.status='red';
  current.guest=''; current.phone=''; current.car=''; current.notes='';
  current.persons=0; current.nights=0; current.rate=0; current.amountPaid=0; current.paid='unpaid'; current.method='';
  save(); render(); dlg.close();
});

// ======= FIRST LOAD =======
ensureAllRooms();
render();
</script>
